#!/bin/sh
set -e

# Set permissions of the bundle jar
chown muc:muc    /opt/openmuc/bundle/<package>-<version>.jar
chown muc:muc -R /etc/ems /var/opt/ems

# If EmonMUC devices are installed, link template files and set permissions
if [ -d /var/opt/emonmuc/device ]; then
    emonuser=$(ls -ld /var/opt/emonmuc/device | awk '{print $3}')
    if [ ! -e /var/opt/emonmuc/device/ems ]; then
        sudo -u $emonuser ln -s /var/opt/ems/dev /var/opt/emonmuc/device/ems
    fi
    chown $emonuser:$emonuser -R /var/opt/ems/dev

    if [ -f "/var/www/emoncms/scripts/admin/device_update.php" ]; then
        php -f "/var/www/emoncms/scripts/admin/device_update.php"
    fi
fi

#DEBHELPER#

# Start service if still idle
if systemctl list-unit-files --all --type service --full --no-legend | grep -Fq "openmuc.service" \
&& ! systemctl is-active --quiet openmuc ; then
    systemctl start openmuc
fi

exit 0
