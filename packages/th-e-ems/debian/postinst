#!/bin/sh
set -e

if ! grep -q "org.the.ems.config.*=" /opt/openmuc/conf/system.properties; then
    header_line=$((`grep -m1 -n "OpenMUC framework config properties" /opt/openmuc/conf/system.properties | sed "s/:.*//g"` - 1))

    sed -i -e "$header_line i\\
#\\
# TH-E EMS framework config properties\\
#\\
\\
# The location of the component config files, default is conf\/components\/\\
org.the.ems.config = \/etc\/ems\\
" /opt/openmuc/conf/system.properties
fi

# Set permissions of the framework directories
chown muc:muc    /opt/openmuc/bundle/th-e-*
chown muc:muc -R /etc/ems /var/opt/ems

# If EmonMUC devices are installed, link template files and set permissions
if [ -d /var/opt/emonmuc/device ]; then
    emonuser=$(ls -ld /var/opt/emonmuc/device | awk '{print $3}')
    if [ ! -e /var/opt/emonmuc/device/ems ]; then
        sudo -u $emonuser ln -s /var/opt/ems/dev /var/opt/emonmuc/device/ems
    fi
    chown $emonuser:$emonuser -R /var/opt/ems/dev

    if [ -f "/var/www/emoncms/scripts/admin/device_update.php" ]; then
        php -f "/var/www/emoncms/scripts/admin/device_update.php"
    fi
fi

#DEBHELPER#

# Start service if still idle
if ! systemctl is-active --quiet openmuc; then
    systemctl start openmuc
fi

exit 0
